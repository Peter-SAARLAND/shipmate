- name: "Ahoi!"
  hosts: shipmate
  connection: local
  gather_facts: true
  tasks:
    - name: Loading Default .releaserc
      template:
        src: templates/.releaserc.yml.j2
        dest: "{{ shipmate_cargo_dir }}/.releaserc.yml"
    - debug: 
        msg: 
          - "Docker Image: {{ docker_image }}"
          - "Project Name: {{ shipmate_project_name }}"
          - "Shipmate Providers: {{ shipmate_providers }}"
          - "Shipmate Stage: {{ shipmate_stage }}"
    
    - name: "Running Stage"
      include: "stage-{{ shipmate_stage }}.yml"

    - name: "Clean up Paperwork"
      file:
        state: absent
        path: "{{ item }}"
      with_items:
        - "{{ shipmate_cargo_dir }}/{{ shipmate_version_file }}"
        - "{{ shipmate_cargo_dir }}/.releaserc.yml"
        - "{{ shipmate_cargo_dir }}/CHANGELOG.md"
      when: >
        not shipmate_ci
    
    - name: "Reporting on Shipment"
      debug:
        msg: 
          - "Stage: {{ shipmate_stage }}"
          - "Commit ID: {{ shipmate_commit_id }}"
          - "Commit Message: {{ shipmate_commit_message }}"
          - "Branch: {{ shipmate_branch }}"
          - "Image: {{ docker_image }}"
          - "Providers: {{ shipmate_providers_string }}"
          - "Merge Request ID: {{ lookup('env', 'CI_MERGE_REQUEST_ID') | default('UNKNOWN', true) }}"
          - "Merge Request IID: {{ lookup('env', 'CI_MERGE_REQUEST_IID') | default('UNKNOWN', true) }}"
          - "Version: {{ shipmate_cargo_version | default('UKNOWN') }}"
      when: "shipmate_cargo_version != '' or shipmate_cargo_version is defined"